#!/bin/bash

# Valid Script
ipsaya=$(curl -sS ipv4.icanhazip.com)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")


# Rainbow output disabled

# Variables
ip=$(wget -qO- ipv4.icanhazip.com)
server_date=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date=$(date +"%Y-%m-%d" -d "$server_date")
city=$(cat /etc/xray/city 2>/dev/null || echo "Unknown city")
public_key=$(cat /etc/slowdns/server.pub 2>/dev/null || echo "Public key not available")
ns_domain=$(cat /etc/xray/dns 2>/dev/null || echo "NS domain not set")
domain=$(cat /etc/xray/domain 2>/dev/null || hostname -f)


clear

# User data input
echo "┌─────────────────────────────────────────┐"
echo "│     Input SSH trial account data        │"
echo "│            Enter User Data              │"
echo "└─────────────────────────────────────────┘"

# # Generate random username
# user=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 8 | head -n 1)

# echo "   Username : $user"
# until [[ $duration =~ ^[0-9]+$ ]]; do
#     read -p "   Active period (minutes): " duration
#     if [[ -z "$duration" ]]; then
#         echo -e "${red}   Active period cannot be empty${reset}"
#     fi
# done


while true; do
    read -p "   Name: " user
    if [[ ${#user} -lt 3 || ! "$user" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        printf "\033[1A\033[0J"
        echo -e "${red}   Username cannot be empty${reset}"
        continue
    fi
    if grep -q "^### $user " /etc/ssh/.ssh.db; then
        random_number=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 5)
        user="${random_number}${user}"
        echo -e "${yellow}   Username already exists. New username used: $user${reset}"
        break
    else
        break
    fi
done

until [[ $duration =~ ^[0-9]+$ ]]; do
    read -p "   Active period (minutes): " duration
    if [[ -z "$duration" ]]; then
        echo -e "${red}   Active period cannot be empty${reset}"
    fi
done

# Account creation process
expiration=$(date -d "+$duration minutes" +"%Y-%m-%d %H:%M:%S")

# Create SSH account
useradd -e $(date -d "+$duration minutes" +"%Y-%m-%d") -s /bin/false -M $user
echo "$user:$user" | chpasswd

# Run tmux session to delete account after duration expires
tmux new-session -d -s "trial_ssh_$user" "trial trialssh $user $duration"

clear
echo -e "—————————————————————————————————————"
echo -e "     SSH OVPN Account      "
echo -e "───────────────────────────"
echo -e "Username         : $user"
echo -e "Password         : $user"
echo -e "—————————————————————————————————————"
echo -e "IP               : $ip"
echo -e "Host             : $domain"
echo -e "Location         : $city"
echo -e "OpenSSH Port     : 443, 80, 22"
echo -e "UdpSSH Port      : 1-65535"
echo -e "DNS Port         : 443, 53, 22"
echo -e "Dropbear Port    : 443, 109"
echo -e "SSH WS Port      : 80"
echo -e "SSH SSL WS Port  : 443"
echo -e "SSL/TLS Port     : 443"
echo -e "OVPN SSL Port    : 443"
echo -e "OVPN TCP Port    : 1194"
echo -e "OVPN UDP Port    : 2200"
echo -e "BadVPN UDP       : 7100, 7300, 7300"
echo -e "SlowDns Public Key: ${pubkey}"
echo -e "—————————————————————————————————————"
echo -e "WSS Payload      : GET wss://BUG.COM/ HTTP/1.1[crlf]Host: $domain[crlf]Upgrade: websocket[crlf][crlf]"
echo -e "—————————————————————————————————————"
echo -e "OpenVPN Link     : https://$domain:81/allovpn.zip"
echo -e "—————————————————————————————————————"
echo -e "Save Account Link: https://$domain:81/ssh-$user.txt"
echo -e "—————————————————————————————————————"
echo -e "Expiration       : $duration minutes"
